generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
  engineType      = "client" // enable Prisma ORM without Rust (so it works on Vercel Edge)
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Admin users who can review submissions
model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  reviews   Review[]

  @@map("users")
}

// Artists who submit demos
model Artist {
  id          String       @id @default(uuid()) @db.Uuid
  name        String
  email       String       @unique
  phone       String?
  instagram   String?
  soundcloud  String?
  spotify     String?
  bio         String?      @db.Text
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  submissions Submission[]

  @@map("artists")
}

// Demo submissions from artists
model Submission {
  id          String           @id @default(uuid()) @db.Uuid
  artistId    String           @db.Uuid
  artist      Artist           @relation(fields: [artistId], references: [id], onDelete: Cascade)
  status      SubmissionStatus @default(PENDING)
  submittedAt DateTime         @default(now())
  tracks      Track[]
  reviews     Review[]
  
  @@map("submissions")
  @@index([artistId])
  @@index([status])
}

enum SubmissionStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
}

// Reviews by admin users on submissions
model Review {
  id            String   @id @default(uuid()) @db.Uuid
  submissionId  String   @db.Uuid
  submission    Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  reviewerId    String   @db.Uuid
  reviewer      User     @relation(fields: [reviewerId], references: [id], onDelete: Cascade)
  grade         Int?     // 1-10 scale
  internalNotes String?  @db.Text
  feedback      String?  @db.Text // Feedback to be shared with artist
  reviewedAt    DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("reviews")
  @@index([submissionId])
}

// Individual tracks within a submission
model Track {
  id           String     @id @default(uuid()) @db.Uuid
  submissionId String     @db.Uuid
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  title        String
  genre        String?
  bpm          Int?
  key          String?
  description  String?    @db.Text
  fileUrl      String     // Cloudinary URL (original file)
  streamUrl    String?    // Cloudinary URL for MP3 version (from eager transform)
  publicId     String     // Cloudinary public ID for management (required for deletion)
  fileType     String     // e.g., "audio/mpeg", "audio/wav"
  fileSize     Int        // Size in bytes
  duration     Float?     // Duration in seconds
  createdAt    DateTime   @default(now())
  
  @@map("tracks")
  @@index([submissionId])
}

// Email templates for automated communications
model EmailTemplate {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique // e.g., "submission_confirmation", "approval", "rejection"
  subject     String
  htmlContent String   @db.Text
  variables   String[] // Available variables like ["artist_name", "submission_id"]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("email_templates")
}
